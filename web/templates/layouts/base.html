<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} - {{ end }}ZhuLink 竹林</title>
    <link rel="icon" type="image/svg+xml" href="/static/img/logo.svg">
    <link href="/static/css/style.css?v=4" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.10/dist/htmx.min.js"></script>
    <!-- 禁用 HTMX 历史缓存，避免内存累积 -->
    <meta name="htmx-config" content='{"historyCacheSize":0}'>
    <!-- Sitemap引用 -->
    <link rel="sitemap" type="application/xml" href="/sitemap.xml">
    <!-- RSS Feed引用 -->
    <link rel="alternate" type="application/rss+xml" title="ZhuLink RSS Feed" href="/feed.xml">
    <!-- Marked.js & Editor.js (Optional via block) -->
    {{ block "scripts" . }}{{ end }}
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<!-- 设计理念: 白纸墨字, 点翠成林 -->

<body class="bg-paper text-ink font-sans antialiased min-h-screen flex flex-col selection:bg-moss selection:text-white">

    <!-- ==================== PC 端顶栏 (Desktop Header) ==================== -->
    <!-- 设计关键词：沉浸、浏览、身份 -->
    <header class="hidden md:block fixed w-full top-0 z-50 bg-paper/90 backdrop-blur-md border-b border-stone-100">
        <div class="container mx-auto px-6 py-1.5 flex items-center justify-between max-w-6xl">
            <!-- 左侧: 品牌 + 核心导航 -->
            <div class="flex items-center space-x-6">
                <!-- Logo -->
                <a href="/" class="flex items-center space-x-2 group">
                    <img src="/static/img/logo.svg" alt="ZhuLink Logo" class="h-6 w-auto">
                    <span class="font-semibold text-lg tracking-wide text-ink">ZhuLink</span>
                </a>

                <!-- 核心流入口: 纯文字，选中状态用加粗+底部绿线 -->
                <nav class="flex items-center space-x-5 text-[15px]">
                    <a href="/" class="relative py-0.5 transition-colors {{ if eq .Active " top" }}text-ink
                        font-semibold{{ else }}text-ink-light hover:text-ink{{ end }}">
                        热门
                        {{ if eq .Active "top" }}<span
                            class="absolute bottom-0 left-0 right-0 h-0.5 bg-moss rounded-full"></span>{{ end }}
                    </a>
                    <a href="/new" class="relative py-0.5 transition-colors {{ if eq .Active " new" }}text-ink
                        font-semibold{{ else }}text-ink-light hover:text-ink{{ end }}">
                        最新
                        {{ if eq .Active "new" }}<span
                            class="absolute bottom-0 left-0 right-0 h-0.5 bg-moss rounded-full"></span>{{ end }}
                    </a>
                    <a href="/nodes" class="relative py-0.5 transition-colors {{ if eq .Active " nodes" }}text-ink
                        font-semibold{{ else }}text-ink-light hover:text-ink{{ end }}">
                        节点
                        {{ if eq .Active "nodes" }}<span
                            class="absolute bottom-0 left-0 right-0 h-0.5 bg-moss rounded-full"></span>{{ end }}
                    </a>
                    <a href="/rss" class="relative py-0.5 transition-colors {{ if eq .Active " rss" }}text-ink
                        font-semibold{{ else }}text-ink-light hover:text-ink{{ end }}">
                        苗圃
                        {{ if eq .Active "rss" }}<span
                            class="absolute bottom-0 left-0 right-0 h-0.5 bg-moss rounded-full"></span>{{ end }}
                    </a>
                    <a href="/search" class="relative py-0.5 transition-colors {{ if eq .Active " search" }}text-ink
                        font-semibold{{ else }}text-ink-light hover:text-ink{{ end }}">
                        搜索
                        {{ if eq .Active "search" }}<span
                            class="absolute bottom-0 left-0 right-0 h-0.5 bg-moss rounded-full"></span>{{ end }}
                    </a>
                </nav>
            </div>

            <!-- 中间: 留白 (flex-grow 自动撑开) -->
            <div class="flex-grow"></div>

            <!-- 右侧: 用户状态 -->
            <div class="text-sm tracking-wide flex items-center space-x-3">
                {{ if .CurrentUser }}
                <!-- 已登录: 头像 + 用户名 + 下拉菜单 -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open" @click.outside="open = false"
                        class="flex items-center space-x-2 hover:bg-stone-50 px-2 py-1 rounded-md transition-colors">
                        <span class="text-lg leading-none">{{ .CurrentUser.Avatar }}</span>
                        <span class="text-ink-light">{{ .CurrentUser.Username }}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"
                            :class="{ 'rotate-180': open }"></i>
                    </button>
                    <!-- 下拉菜单 -->
                    <div x-show="open" x-cloak x-transition:enter="transition ease-out duration-150"
                        x-transition:enter-start="opacity-0 translate-y-1"
                        x-transition:enter-end="opacity-100 translate-y-0"
                        x-transition:leave="transition ease-in duration-100"
                        x-transition:leave-start="opacity-100 translate-y-0"
                        x-transition:leave-end="opacity-0 translate-y-1"
                        class="absolute right-0 mt-1 w-40 bg-white border border-stone-100 rounded-lg shadow-xl py-1 z-[60]">
                        <a href="/u/{{ .CurrentUser.ID }}"
                            class="block px-3 py-1.5 text-ink-light hover:text-moss hover:bg-stone-50 transition-colors">我的主页</a>
                        <a href="/dashboard"
                            class="block px-3 py-1.5 text-ink-light hover:text-moss hover:bg-stone-50 transition-colors">个人后台</a>
                        <div class="h-px bg-stone-50 my-1"></div>
                        <a href="/logout"
                            class="block px-3 py-1.5 text-ink-light hover:text-red-600 hover:bg-stone-50 transition-colors">退出</a>
                    </div>
                </div>
                <!-- 通知图标 -->
                <a href="/dashboard/notifications" class="relative group ml-1">
                    <div
                        class="p-1.5 rounded-full hover:bg-stone-50 transition-colors text-ink-light group-hover:text-moss">
                        <i data-lucide="bell" class="w-4 h-4"></i>
                        {{ if .UnreadCount }}
                        <span
                            class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                        {{ end }}
                    </div>
                </a>
                {{ else }}
                <!-- 未登录 -->
                <div class="flex items-center space-x-3 text-ink-light">
                    <a href="/login" class="hover:text-ink transition-colors">登录</a>
                    <span class="text-stone-300">/</span>
                    <a href="/signup" class="hover:text-ink transition-colors">注册</a>
                </div>
                {{ end }}
            </div>
        </div>
    </header>

    <!-- ==================== 手机端顶栏 (Mobile Header) ==================== -->
    <!-- 设计关键词：效率、行动、紧凑 -->
    <header class="md:hidden fixed w-full top-0 z-50 bg-paper/90 backdrop-blur-md border-b border-stone-100">
        <div class="px-4 py-1.5 flex items-center justify-between max-w-6xl mx-auto">
            <!-- 左侧: Logo + 网站名称 + 导航 -->
            <div class="flex items-center space-x-3">
                <!-- Logo + 名称 -->
                <a href="/" class="flex items-center space-x-1">
                    <img src="/static/img/logo.svg" alt="ZhuLink" class="h-4 w-auto">
                    <span class="font-semibold text-xs text-ink">ZhuLink</span>
                </a>

                <!-- 核心导航 -->
                <nav class="flex items-center space-x-2 text-xs">
                    <a href="/" class="transition-colors {{ if eq .Active " top" }}text-ink font-medium{{ else
                        }}text-ink-light{{ end }}">热门</a>
                    <span class="text-stone-200">|</span>
                    <a href="/new" class="transition-colors {{ if eq .Active " new" }}text-ink font-medium{{ else
                        }}text-ink-light{{ end }}">最新</a>
                    <span class="text-stone-200">|</span>
                    <a href="/nodes" class="transition-colors {{ if eq .Active " nodes" }}text-ink font-medium{{ else
                        }}text-ink-light{{ end }}">节点</a>
                    <span class="text-stone-200">|</span>
                    <a href="/rss" class="transition-colors {{ if eq .Active " rss" }}text-ink font-medium{{ else
                        }}text-ink-light{{ end }}">苗圃</a>
                    <span class="text-stone-200">|</span>
                    <a href="/search" class="transition-colors {{ if eq .Active " search" }}text-ink font-medium{{ else
                        }}text-ink-light{{ end }}">搜索</a>
                </nav>
            </div>

            <!-- 右侧: 发布 + 用户 -->
            <div class="flex items-center space-x-2">
                <!-- 发布按钮: 醒目的品牌色 -->
                <a href="/submit"
                    class="flex items-center justify-center w-6 h-6 bg-moss text-white rounded-full hover:bg-moss-dark transition-colors">
                    <!-- + 图标 -->
                    <i data-lucide="plus" class="w-3 h-3"></i>
                </a>

                {{ if .CurrentUser }}
                <!-- 通知 -->
                <a href="/dashboard/notifications"
                    class="flex items-center space-x-0.5 {{ if gt .UnreadCount 0 }}text-red-500{{ else }}text-ink-light{{ end }}">
                    <i data-lucide="bell" class="w-4 h-4 {{ if gt .UnreadCount 0 }}fill-current{{ end }}"></i>
                    {{ if gt .UnreadCount 0 }}<span class="text-[10px] font-bold">{{ .UnreadCount }}</span>{{ end }}
                </a>

                <!-- 已登录: emoji 头像 -->
                <a href="/dashboard"
                    class="flex items-center justify-center text-xl hover:opacity-80 transition-opacity">
                    {{ .CurrentUser.Avatar }}
                </a>
                {{ else }}
                <!-- 未登录: 登录 -->
                <a href="/login" class="text-xs text-ink-light hover:text-ink transition-colors">登录</a>
                {{ end }}
            </div>
        </div>
    </header>

    <!-- 固定 Header 占位 -->
    <div class="h-9 md:h-10"></div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 md:px-6 py-6 md:py-10 max-w-6xl border-x border-stone-100">
        {{ template "content" . }}
    </main>

    <!-- Footer: 极简 -->
    <footer class="border-t border-stone-100 mt-auto py-8">
        <div class="container mx-auto px-6 text-center max-w-6xl">
            <p class="font-bold text-lg text-ink tracking-widest mb-4">ZhuLink · 竹林</p>
            <div class="flex items-center justify-center space-x-8 text-xs text-ink-light uppercase tracking-[0.2em]">
                <a href="/p/about" class="hover:text-moss transition-colors">关于</a>
                <span class="text-stone-200">|</span>
                <a href="/p/guide" class="hover:text-moss transition-colors">指南</a>
                <span class="text-stone-200">|</span>
                <a href="#top" class="hover:text-moss transition-colors">回到顶部</a>
            </div>
        </div>
    </footer>

    <!-- 全局 Toast 通知组件 -->
    <div x-data="{
        show: false,
        message: '',
        type: 'success',
        showToast(msg, toastType = 'success') {
            this.message = msg;
            this.type = toastType;
            this.show = true;
            setTimeout(() => { this.show = false; }, 3000);
        }
    }" @show-toast.window="showToast($event.detail.message, $event.detail.type)"
        @show-error.window="showToast($event.detail.message, 'error')"
        @show-success.window="showToast($event.detail.message, 'success')"
        class="fixed inset-0 z-[60] pointer-events-none">

        <!-- Toast 消息框 -->
        <div x-show="show" x-cloak x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 translate-y-2"
            class="fixed bottom-8 right-8 flex items-center space-x-3 px-5 py-3 rounded-lg shadow-lg max-w-md pointer-events-auto"
            :class="{
                'bg-green-50 border border-green-200 text-green-700': type === 'success',
                'bg-red-50 border border-red-200 text-red-700': type === 'error'
            }">

            <!-- 图标 (预渲染所有可能的图标，避免动态扫描) -->
            <div class="flex-shrink-0">
                <i data-lucide="check-circle" x-show="type === 'success'" class="w-5 h-5"></i>
                <i data-lucide="alert-circle" x-show="type === 'error'" class="w-5 h-5"></i>
            </div>

            <!-- 消息文本 -->
            <span class="text-sm font-medium" x-text="message"></span>

            <!-- 关闭按钮 -->
            <button @click="show = false" class="ml-2 hover:opacity-70 transition-opacity cursor-pointer">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- 初始化 Lucide Icons -->
    <script>
        // 初始化页面上的图标（只执行一次）
        lucide.createIcons();

        // 防抖渲染 Lucide 图标（限制作用范围）
        window.__lucideTimeout = null;
        function renderLucideIconsIn(container) {
            if (window.__lucideTimeout) clearTimeout(window.__lucideTimeout);
            window.__lucideTimeout = setTimeout(() => {
                if (container && container.querySelectorAll) {
                    const icons = container.querySelectorAll('i[data-lucide]:not([data-lucide-rendered])');
                    if (icons.length > 0) {
                        icons.forEach(icon => {
                            icon.setAttribute('data-lucide-rendered', 'true');
                        });
                        // 只渲染传入的特定节点，避免扫描全页面
                        lucide.createIcons({
                            nodes: Array.from(icons)
                        });
                    }
                }
            }, 50);
        }

        // HTMX 内容替换后只渲染新内容区域的图标
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            renderLucideIconsIn(evt.detail.target);
        });

        // 处理非 2xx 响应中的 HX-Trigger（HTMX 默认不处理错误响应的 Trigger）
        document.body.addEventListener('htmx:responseError', function (evt) {
            const xhr = evt.detail.xhr;
            const trigger = xhr.getResponseHeader('HX-Trigger');
            if (trigger) {
                try {
                    // 解码 URL 编码的 JSON
                    const decoded = decodeURIComponent(trigger);
                    const events = JSON.parse(decoded);
                    // 触发所有事件
                    for (const [eventName, detail] of Object.entries(events)) {
                        window.dispatchEvent(new CustomEvent(eventName, { detail: detail }));
                    }
                } catch (e) {
                    console.error('Failed to parse HX-Trigger from error response:', e);
                }
            }
        });
    </script>

</body>

</html>