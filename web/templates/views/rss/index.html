{{ define "content" }}
<div class="min-h-[70vh]" hx-history="false" x-data="{
    showAddModal: false,
    selectedCategory: '{{ if .Categories }}{{ index .Categories 0 }}{{ end }}',
    readerItem: null
}">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
        <!-- å·¦ä¾§è¾¹æ  (æ¡Œé¢ç«¯æ˜¾ç¤º) -->
        <aside class="hidden md:block md:col-span-3">
            <div class="sticky top-16">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-lg font-bold text-ink">ğŸŒ± è‹—åœƒ</h1>
                    <div class="text-xs text-ink-light bg-stone-100 px-2 py-1 rounded-md">
                        {{ .CurrentRSSCount }}{{ if ne .MaxRSSCount -1 }}/{{ .MaxRSSCount }}{{ end }}
                    </div>
                </div>
                <!-- æ·»åŠ è®¢é˜…æŒ‰é’® -->
                <button @click="showAddModal = true"
                    class="w-full flex items-center justify-center space-x-2 px-4 py-2.5 mb-2 text-sm bg-moss text-white rounded-lg hover:bg-moss-dark transition-colors cursor-pointer">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>æ·»åŠ è®¢é˜…</span>
                </button>

                <!-- å‘ç°çƒ­é—¨å…¥å£ -->
                <a href="/rss/popular"
                    class="w-full flex items-center justify-center space-x-2 px-4 py-2.5 mb-6 text-sm border border-stone-200 text-ink-light hover:text-moss hover:border-moss rounded-lg transition-colors">
                    <i data-lucide="flame" class="w-4 h-4"></i>
                    <span>å‘ç°çƒ­é—¨è®¢é˜…</span>
                </a>

                <!-- åˆ†ç±»åˆ—è¡¨ -->
                {{ if .Categories }}
                <div class="px-4 py-2 text-sm font-semibold text-ink-light tracking-wider mb-1">
                    è®¢é˜…åˆ†ç±»
                </div>
                <nav class="space-y-0.5">
                    {{ range $index, $cat := .Categories }}
                    <button hx-get="/rss/feeds?category={{ $cat }}" hx-target="#rss-main-container" hx-swap="innerHTML"
                        @click="selectedCategory = '{{ $cat }}'" :class="selectedCategory === '{{ $cat }}'
                            ? 'text-ink font-medium border-l-2 border-moss bg-stone-50'
                            : 'text-ink-light hover:text-ink hover:bg-stone-50 border-l-2 border-transparent'"
                        class="w-full text-left px-4 py-2 transition-colors cursor-pointer">
                        <span>{{ $cat }}</span>
                    </button>
                    {{ end }}
                </nav>
                {{ else }}
                <!-- ç©ºçŠ¶æ€ -->
                <div class="text-center py-8 text-ink-light">
                    <div class="text-3xl mb-2">ğŸ“­</div>
                    <p class="text-sm">æš‚æ— è®¢é˜…åˆ†ç±»</p>
                    <p class="text-xs mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>
                </div>
                {{ end }}

                <!-- åº•éƒ¨æç¤º -->
                <div class="mt-8 p-4 bg-stone-50 rounded-lg text-sm text-ink-light">
                    <p class="mb-2">ğŸ’¡ ä½¿ç”¨æŠ€å·§</p>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li>ç‚¹å‡»åˆ†ç±»æŸ¥çœ‹è®¢é˜…æº</li>
                        <li>ç‚¹å‡»è®¢é˜…æºæŸ¥çœ‹æ–‡ç« </li>
                        <li>æ–‡ç« æŒ‰æ—¶é—´æ­£åºæ’åˆ—</li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»å†…å®¹åŒº (å…±ç”¨) -->
        <main class="col-span-1 md:col-span-9">
            <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨ (æ ‡é¢˜ + æŒ‰é’® + åˆ†ç±»èƒ¶å›Š) -->
            <div class="md:hidden mb-6">
                <!-- æ ‡é¢˜ + æ·»åŠ æŒ‰é’® -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center justify-between mb-1">
                        <h1 class="text-lg font-bold text-ink">ğŸŒ± è‹—åœƒ</h1>
                        <div class="text-xs text-ink-light bg-stone-100 px-2 py-1 rounded-md">
                            {{ .CurrentRSSCount }}{{ if ne .MaxRSSCount -1 }}/{{ .MaxRSSCount }}{{ end }}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <a href="/rss/popular"
                            class="flex items-center space-x-1 px-3 py-1.5 text-sm border border-orange-200 text-orange-600 rounded-lg">
                            <i data-lucide="flame" class="w-4 h-4"></i>
                            <span>çƒ­é—¨</span>
                        </a>
                        <button @click="showAddModal = true"
                            class="flex items-center space-x-1 px-3 py-1.5 text-sm bg-moss text-white rounded-lg">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>è®¢é˜…</span>
                        </button>
                    </div>
                </div>

                <!-- æ¨ªå‘æ»šåŠ¨åˆ†ç±»èƒ¶å›Š (å°åœ†è§’) -->
                {{ if .Categories }}
                <div class="flex space-x-2 overflow-x-auto pb-3 -mx-4 px-4 scrollbar-hide">
                    {{ range $index, $cat := .Categories }}
                    <button hx-get="/rss/feeds?category={{ $cat }}" hx-target="#rss-main-container" hx-swap="innerHTML"
                        @click="selectedCategory = '{{ $cat }}'" :class="selectedCategory === '{{ $cat }}'
                            ? 'bg-moss text-white'
                            : 'bg-stone-100 text-ink-light hover:bg-stone-200'"
                        class="flex-shrink-0 px-4 py-2 rounded-lg text-sm transition-colors whitespace-nowrap">
                        {{ $cat }}
                    </button>
                    {{ end }}
                </div>
                {{ end }}
            </div>

            <!-- RSS å†…å®¹å®¹å™¨ (Target) -->
            <div id="rss-main-container" {{ if .Categories }}
                hx-get="/rss/feeds?category={{ index .Categories 0 | urlquery }}" hx-trigger="load" hx-swap="innerHTML"
                {{ end }}>
                <!-- åˆå§‹çŠ¶æ€ -->
                <div class="flex flex-col items-center justify-center py-20 text-center text-ink-light">
                    <div class="text-6xl mb-4">ğŸ“¡</div>
                    <h2 class="text-xl font-medium text-ink mb-2">å¼€å§‹é˜…è¯»</h2>
                    <p class="text-sm hidden md:block">ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼Œæˆ–æ·»åŠ æ–°çš„è®¢é˜…æº</p>
                    <p class="text-sm md:hidden">ç‚¹å‡»ä¸Šæ–¹åˆ†ç±»å¼€å§‹é˜…è¯»</p>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== æ·»åŠ è®¢é˜…æ¨¡æ€æ¡† ==================== -->
    <div x-show="showAddModal" x-cloak x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
        @click.self="showAddModal = false">

        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6"
            x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100">

            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-ink">æ·»åŠ è®¢é˜…</h3>
                <button @click="showAddModal = false" class="text-ink-light hover:text-ink cursor-pointer">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form hx-post="/rss/subscribe" hx-indicator="#add-loading"
                @htmx:after-request="if(event.detail.successful && event.detail.xhr.status === 200) { showAddModal = false; setTimeout(() => location.reload(), 1500); }"
                @htmx:timeout="window.dispatchEvent(new CustomEvent('show-error', { detail: { message: 'è¯·æ±‚è¶…æ—¶ï¼ŒRSS è®¢é˜…æºå¯èƒ½å“åº”è¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•' } }))">

                <div class="space-y-4">
                    <!-- RSS åœ°å€ -->
                    <div>
                        <label class="block text-sm font-medium text-ink mb-1">RSS åœ°å€</label>
                        <input type="url" name="url" required placeholder="https://example.com/feed.xml"
                            class="w-full px-4 py-2.5 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-moss/50 focus:border-moss transition-colors">
                    </div>

                    <!-- è‡ªå®šä¹‰æ ‡é¢˜ -->
                    <div>
                        <label class="block text-sm font-medium text-ink mb-1">è‡ªå®šä¹‰æ ‡é¢˜ <span
                                class="text-ink-light">(å¯é€‰)</span></label>
                        <input type="text" name="title" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨åŸæ ‡é¢˜"
                            class="w-full px-4 py-2.5 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-moss/50 focus:border-moss transition-colors">
                    </div>

                    <!-- åˆ†ç±» -->
                    <div x-data="{ category: '' }">
                        <label class="block text-sm font-medium text-ink mb-1">åˆ†ç±»</label>
                        <input type="text" name="category" x-model="category" value="" placeholder="ç»™è®¢é˜…åˆ†ä¸ªç±»ï¼Œæ–¹ä¾¿ä»¥åæŸ¥æ‰¾"
                            class="w-full px-4 py-2.5 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-moss/50 focus:border-moss transition-colors">

                        {{ if .Categories }}
                        <!-- ç°æœ‰åˆ†ç±»å¿«æ·é€‰æ‹© -->
                        <div class="mt-2 text-xs text-ink-light mb-1">æˆ–æ˜¯é€‰æ‹©å·²æœ‰åˆ†ç±»ï¼š</div>
                        <div class="flex flex-wrap gap-2">
                            {{ range .Categories }}
                            <button type="button" @click="category = '{{ . }}'"
                                class="px-2.5 py-1.5 text-xs bg-stone-100 text-ink-light rounded-lg hover:bg-moss hover:text-white transition-colors cursor-pointer border border-stone-200">
                                {{ . }}
                            </button>
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="mt-6">
                    <button type="submit"
                        class="w-full py-2.5 bg-moss text-white rounded-lg hover:bg-moss-dark transition-colors font-medium cursor-pointer flex items-center justify-center">
                        <!-- åŠ è½½å›¾æ ‡ (é»˜è®¤éšè—) -->
                        <span id="add-loading" class="mr-2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </span>
                        <span>æ·»åŠ è®¢é˜…</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== é˜…è¯»å™¨å…¨å± Overlay (ç®€åŒ–ç‰ˆ - Vanilla JS) ==================== -->
    <div id="reader-overlay" class="hidden fixed inset-0 z-[60] bg-stone-50/90 backdrop-blur-sm overflow-y-auto">
        <div class="max-w-4xl mx-auto bg-white shadow-xl min-h-screen" id="reader-content">
            <!-- HTMX åŠ è½½å†…å®¹åˆ°è¿™é‡Œ -->
        </div>
    </div>

    <script>
        // ==================== å†…å­˜ç®¡ç† ====================

        // é˜²æ­¢äº‹ä»¶ç›‘å¬å™¨é‡å¤ç»‘å®š
        if (!window.__rssEventsBound) {
            window.__rssEventsBound = true;

            // HTMX æ›¿æ¢å‰é”€æ¯æ—§ç»„ä»¶
            document.body.addEventListener('htmx:beforeSwap', function (evt) {
                if (evt.detail.target.id === 'rss-main-container' || evt.detail.target.id === 'reader-content') {
                    const oldContent = evt.detail.target;
                    // é”€æ¯ Alpine.js ç»„ä»¶
                    if (window.Alpine && oldContent.querySelector('[x-data]')) {
                        try {
                            Alpine.destroyTree(oldContent);
                        } catch (e) {
                            console.warn('Alpine.destroyTree failed:', e);
                        }
                    }
                    // æ¸…é™¤å¯èƒ½çš„å›¾ç‰‡/è§†é¢‘èµ„æº
                    oldContent.querySelectorAll('img, iframe, video').forEach(el => {
                        el.src = '';
                        el.remove();
                    });
                }
            });

            // ESC é”®å…³é—­
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('reader-overlay').classList.contains('hidden')) {
                    hideReader();
                }
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            document.getElementById('reader-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'reader-overlay') {
                    hideReader();
                }
            });

            // HTMX åŠ è½½å®Œæˆåæ¸²æŸ“å›¾æ ‡ï¼ˆä½¿ç”¨ base.html çš„å…¨å±€å‡½æ•°ï¼‰
            document.body.addEventListener('htmx:afterSwap', function (evt) {
                if (evt.detail.target.id === 'rss-main-container' || evt.detail.target.id === 'reader-content') {
                    if (window.renderLucideIconsIn) {
                        renderLucideIconsIn(evt.detail.target);
                    }
                }
            });
        }

        // ==================== é˜…è¯»å™¨ ====================

        // æ˜¾ç¤ºé˜…è¯»å™¨
        function showReader() {
            document.getElementById('reader-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // éšè—é˜…è¯»å™¨ï¼ˆå¢å¼ºèµ„æºé‡Šæ”¾ï¼‰
        function hideReader() {
            const overlay = document.getElementById('reader-overlay');
            const content = document.getElementById('reader-content');

            // 1. é”€æ¯ Alpine.js ç»„ä»¶
            if (window.Alpine && content.querySelector('[x-data]')) {
                try {
                    Alpine.destroyTree(content);
                } catch (e) {
                    console.warn('Alpine.destroyTree failed:', e);
                }
            }

            // 2. ç§»é™¤æ‰€æœ‰åª’ä½“èµ„æºï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
            content.querySelectorAll('img, iframe, video, audio').forEach(el => {
                el.src = '';
                el.remove();
            });

            // 3. æ¸…ç©ºå†…å®¹
            content.innerHTML = '';

            // 4. éšè— overlay
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // åŠ è½½æ–‡ç« ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
        function loadArticle(id) {
            // å…ˆæ¸…ç©ºæ—§å†…å®¹ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const content = document.getElementById('reader-content');

            // é”€æ¯æ—§ç»„ä»¶
            if (window.Alpine && content.querySelector('[x-data]')) {
                try {
                    Alpine.destroyTree(content);
                } catch (e) { }
            }

            // æ¸…é™¤æ—§åª’ä½“èµ„æº
            content.querySelectorAll('img, iframe, video, audio').forEach(el => {
                el.src = '';
                el.remove();
            });

            content.innerHTML = '<div class="flex h-64 items-center justify-center text-ink-light"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-moss mr-3"></div>åŠ è½½ä¸­...</div>';
            showReader();
            htmx.ajax('GET', '/rss/read/' + id, { target: '#reader-content', swap: 'innerHTML' });
        }

        // lucide å›¾æ ‡æ¸²æŸ“ç”± base.html çš„ renderLucideIconsIn ç»Ÿä¸€å¤„ç†
    </script>
</div>

<style>
    /* éšè—æ»šåŠ¨æ¡ */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Loading Indicator Logic */
    #add-loading {
        display: none;
    }

    #add-loading.htmx-request {
        display: inline-flex;
    }
</style>
{{ end }}