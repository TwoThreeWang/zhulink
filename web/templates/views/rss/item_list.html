<!-- RSS æ–‡ç« åˆ—è¡¨ (State B) - HTMX Partial - å†…å­˜ä¼˜åŒ–ç‰ˆ -->
<div id="rss-item-list" class="rss-item-list {{ if .ShowAll }}show-all{{ else }}show-unread-only{{ end }}"
    hx-history="false" data-feed-id="{{ .Subscription.FeedID }}" data-category="{{ .Category }}"
    data-show-all="{{ .ShowAll }}"
    hx-get="/rss/items?feed_id={{ .Subscription.FeedID }}&category={{ .Category }}&show_all={{ .ShowAll }}"
    hx-trigger="feed-refreshed from:body" hx-swap="outerHTML" hx-target="this">

    <!-- Header: é¢åŒ…å±‘å¯¼èˆª + æ“ä½œæŒ‰é’® (å¸é¡¶) -->
    <div
        class="sticky top-10 z-10 bg-paper/95 backdrop-blur-sm mb-6 py-4 border-b border-stone-100 -mx-4 px-4 -mt-6 pt-6">

        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 text-sm min-w-0">
                <!-- è¿”å›æŒ‰é’® -->
                <button hx-get="/rss/feeds?category={{ .Category }}" hx-target="#rss-main-container" hx-swap="innerHTML"
                    class="flex items-center text-ink-light hover:text-ink transition-colors cursor-pointer">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </button>

                <!-- åˆ†éš” -->
                <span class="text-stone-300">|</span>

                <!-- åˆ†ç±»é“¾æ¥ -->
                <button hx-get="/rss/feeds?category={{ .Category }}" hx-target="#rss-main-container" hx-swap="innerHTML"
                    class="text-ink-light hover:text-moss transition-colors cursor-pointer truncate">
                    {{ .Category }}
                </button>

                <!-- ç®­å¤´ -->
                <i data-lucide="chevron-right" class="w-4 h-4 text-stone-300 flex-shrink-0"></i>

                <!-- è®¢é˜…æºåç§° -->
                <span class="font-medium text-ink truncate">{{ .FeedTitle }}</span>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex items-center space-x-1 flex-shrink-0">
                <!-- åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ (åç«¯é©±åŠ¨) -->
                <button
                    hx-get="/rss/items?feed_id={{ .Subscription.FeedID }}&category={{ .Category }}&show_all={{ if .ShowAll }}false{{ else }}true{{ end }}"
                    hx-target="#rss-item-list" hx-swap="outerHTML"
                    class="flex items-center space-x-1 px-2.5 py-1.5 text-sm rounded-lg transition-colors cursor-pointer {{ if .ShowAll }}bg-stone-100 text-ink{{ else }}text-ink-light hover:text-ink hover:bg-stone-50{{ end }}"
                    title="{{ if .ShowAll }}ä»…çœ‹æœªè¯»{{ else }}æ˜¾ç¤ºå…¨éƒ¨{{ end }}">
                    <i data-lucide="{{ if .ShowAll }}eye-off{{ else }}eye{{ end }}" class="w-4 h-4"></i>
                </button>

                <!-- æ ‡è®°å…¨éƒ¨å·²è¯» -->
                <button hx-post="/rss/anchor/{{ .Subscription.FeedID }}" hx-swap="none"
                    hx-on::after-request="if(event.detail.successful) { htmx.ajax('GET', '/rss/feeds?category={{ .Category }}', {target:'#rss-main-container', swap:'innerHTML'}) }"
                    class="flex items-center px-2.5 py-1.5 text-sm text-ink-light hover:text-ink hover:bg-stone-50 rounded-lg transition-colors cursor-pointer"
                    title="æ ‡è®°å…¨éƒ¨å·²è¯»">
                    <i data-lucide="check-check" class="w-4 h-4"></i>
                </button>

                <!-- åˆ·æ–° -->
                <button hx-post="/rss/refresh/{{ .Subscription.FeedID }}" hx-swap="none"
                    class="group flex items-center px-2.5 py-1.5 text-sm text-ink-light hover:text-ink hover:bg-stone-50 rounded-lg transition-colors cursor-pointer"
                    title="åˆ·æ–°">
                    <i data-lucide="refresh-cw" class="w-4 h-4 group-[.htmx-request]:animate-spin"></i>
                </button>


            </div>
        </div>
    </div>

    {{ if .Items }}
    <!-- æ–‡ç« åˆ—è¡¨ï¼ˆæ—¶é—´è½´æ ·å¼ï¼‰ -->
    <div id="item-container" class="space-y-1">
        {{ range .Items }}
        <article
            class="rss-item group relative p-4 rounded-lg cursor-pointer {{ if .IsRead }}is-read text-stone-400 bg-stone-50/50 hover:bg-stone-100/50{{ else }}text-ink bg-white hover:bg-stone-50{{ end }}"
            data-item-id="{{ .Item.ID }}" data-published-at='{{ .Item.PublishedAt.Format "2006-01-02T15:04:05Z07:00" }}'
            @mouseenter="if (!$el.classList.contains('is-read') && window.readTracker) {
                window.readTracker.markAsRead($el);
            }" onclick="loadArticle({{ .Item.ID }})">

            <!-- æ—¶é—´è½´æŒ‡ç¤ºå™¨ (å·¦ä¾§) -->
            <div
                class="item-indicator absolute left-0 top-0 bottom-0 w-0.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity {{ if .IsRead }}bg-stone-200{{ else }}bg-moss{{ end }}">
            </div>

            <!-- æ–‡ç« å†…å®¹ -->
            <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0 pr-4">
                    <!-- æ ‡é¢˜ -->
                    <h3
                        class="item-title font-medium leading-snug line-clamp-2 {{ if .IsRead }}text-stone-500{{ else }}text-ink group-hover:text-moss{{ end }}">
                        {{ .Item.Title }}
                    </h3>

                    <!-- æ‘˜è¦ (å¦‚æœæœ‰) -->
                    {{ if .Item.Description }}
                    <p
                        class="item-desc mt-1.5 text-sm line-clamp-2 {{ if .IsRead }}text-stone-400{{ else }}text-ink-light{{ end }}">
                        {{ stripHTML .Item.Description }}
                    </p>
                    {{ end }}
                </div>

                <!-- å‘å¸ƒæ—¶é—´ -->
                <div class="flex-shrink-0 text-right">
                    <time class="text-xs {{ if .IsRead }}text-stone-400{{ else }}text-ink-light{{ end }}">
                        {{ timeAgo .Item.PublishedAt }}
                    </time>
                </div>
            </div>

            <!-- å·²è¯»æ ‡è®° -->
            <div
                class="read-check absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity {{ if not .IsRead }}hidden{{ end }}">
                <i data-lucide="check" class="w-4 h-4 text-stone-300"></i>
            </div>
        </article>
        {{ end }}
    </div>

    <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
    {{ if .HasMore }}
    <div id="load-more-container" class="mt-6 text-center">
        <button
            hx-get="/rss/items?feed_id={{ .Subscription.FeedID }}&category={{ .Category }}&show_all={{ .ShowAll }}&append=true&last_item_id={{ .LastItemID }}"
            hx-target="#load-more-container" hx-swap="outerHTML"
            class="px-4 py-2 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors cursor-pointer text-sm text-ink">
            åŠ è½½æ›´å¤š
        </button>
    </div>
    {{ else }}
    <div class="mt-6 text-center text-ink-light">
        <p class="py-4 text-sm">ğŸ“– {{ if .ShowAll }}å·²åŠ è½½å…¨éƒ¨æ–‡ç« {{ else }}å·²åŠ è½½å…¨éƒ¨æœªè¯»æ–‡ç« {{ end }}</p>
    </div>
    {{ end }}
</div>
{{ else }}
<!-- ç©ºçŠ¶æ€ -->
<div class="flex flex-col items-center justify-center py-20 text-center text-ink-light">
    <div class="text-5xl mb-4">ğŸ“„</div>
    <h3 class="text-lg font-medium text-ink mb-2">{{ if .ShowAll }}æš‚æ— æ–‡ç« {{ else }}å¤ªæ£’äº†ï¼æš‚æ— æœªè¯»æ–‡ç« {{ end }}</h3>
    <p class="text-sm">{{ if .ShowAll }}è¯¥è®¢é˜…æºè¿˜æ²¡æœ‰æŠ“å–åˆ°æ–‡ç« {{ else }}åˆ‡æ¢åˆ°â€œæ˜¾ç¤ºå…¨éƒ¨â€å¯ä»¥æŸ¥çœ‹å†å²è®°å½•{{ end }}</p>
    {{ if .ShowAll }}
    <button hx-post="/rss/refresh/{{ .Subscription.FeedID }}" hx-swap="none"
        class="mt-4 px-4 py-2 bg-moss text-white rounded-lg hover:bg-moss-dark transition-colors cursor-pointer">
        åˆ·æ–°è®¢é˜…æº
    </button>
    {{ else }}
    <button hx-get="/rss/items?feed_id={{ .Subscription.FeedID }}&category={{ .Category }}&show_all=true"
        hx-target="#rss-item-list" hx-swap="outerHTML"
        class="mt-4 px-4 py-2 bg-stone-100 text-ink hover:bg-stone-200 rounded-lg transition-colors cursor-pointer">
        æ˜¾ç¤ºå…¨éƒ¨æ–‡ç« 
    </button>
    {{ end }}
</div>
{{ end }}
</div>

<style>
    /* é™åˆ¶è¡Œæ•° */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* éšè—å·²è¯»æ¡ç›®ï¼ˆä»…æœªè¯»æ¨¡å¼ï¼‰ - è¢«ç¦ç”¨ï¼Œæ”¹ä¸ºç‚¹å‡»åä»…å˜ç°ä¸æ¶ˆå¤± */
    /* .rss-item-list.show-unread-only .rss-item.is-read {
        display: none;
    } */

    /* CSS æ¸²æŸ“ä¼˜åŒ–ï¼šå±å¹•å¤–çš„åˆ—è¡¨é¡¹ä¸æ¸²æŸ“ */
    .rss-item {
        content-visibility: auto;
        contain-intrinsic-size: 0 80px;
    }
</style>

<script>
    // è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰è®¢é˜…æº ID
    function getCurrentFeedId() {
        const listElement = document.getElementById('rss-item-list');
        if (!listElement) {
            console.error('æ— æ³•è·å– rss-item-list å…ƒç´ ');
            return null;
        }
        return parseInt(listElement.dataset.feedId);
    }

    // åˆå§‹åŒ–å·²è¯»è¿½è¸ªå™¨(é˜²æŠ–æ‰¹é‡æ›´æ–°ç‰ˆ)
    if (!window.readTracker) {
        window.readTracker = {
            latestItemId: null,
            latestPublishedAt: null,
            debounceTimer: null,

            markAsRead(el) {
                const itemId = parseInt(el.dataset.itemId);
                const publishedAt = new Date(el.dataset.publishedAt);

                // å‰ç«¯ç«‹å³å˜ç°
                el.classList.add('is-read');
                el.classList.remove('text-ink', 'bg-white', 'hover:bg-stone-50');
                el.classList.add('text-stone-400', 'bg-stone-50/50', 'hover:bg-stone-100/50');

                const title = el.querySelector('.item-title');
                if (title) {
                    title.classList.remove('text-ink', 'group-hover:text-moss');
                    title.classList.add('text-stone-500');
                }

                const desc = el.querySelector('.item-desc');
                if (desc) {
                    desc.classList.remove('text-ink-light');
                    desc.classList.add('text-stone-400');
                }

                const indicator = el.querySelector('.item-indicator');
                if (indicator) {
                    indicator.classList.remove('bg-moss');
                    indicator.classList.add('bg-stone-200');
                }

                const check = el.querySelector('.read-check');
                if (check) {
                    check.classList.remove('hidden');
                }

                // æ›´æ–°æœ€æ–°å·²è¯»çš„ itemï¼ˆæŒ‰å‘å¸ƒæ—¶é—´æ¯”è¾ƒï¼‰
                if (!this.latestPublishedAt || publishedAt > this.latestPublishedAt) {
                    this.latestItemId = itemId;
                    this.latestPublishedAt = publishedAt;
                }

                // é˜²æŠ–: åœæ­¢hover 1ç§’åå‘é€
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.syncNow();
                }, 1000);
            },

            syncNow() {
                if (!this.latestItemId) return;

                const feedId = getCurrentFeedId();
                if (!feedId) return;

                const itemIdToSync = this.latestItemId;  // ä¿å­˜åˆ°å±€éƒ¨å˜é‡ï¼Œé¿å…å¼‚æ­¥å›è°ƒæ—¶å€¼å·²è¢«é‡ç½®
                this.latestItemId = null;
                this.latestPublishedAt = null;

                fetch(`/rss/update-read-anchor/${feedId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemIdToSync })
                }).then(response => {
                    if (response.ok) {
                        console.log('å·²è¯»çŠ¶æ€å·²åŒæ­¥, item_id:', itemIdToSync, 'feedId:', feedId);
                    }
                }).catch(err => {
                    console.error('åŒæ­¥å¤±è´¥:', err);
                });
            }
        };

        window.addEventListener('beforeunload', () => {
            if (window.readTracker.latestItemId) {
                const feedId = getCurrentFeedId();
                if (feedId) {
                    const blob = new Blob(
                        [JSON.stringify({ item_id: window.readTracker.latestItemId })],
                        { type: 'application/json' }
                    );
                    navigator.sendBeacon(
                        `/rss/update-read-anchor/${feedId}`,
                        blob
                    );
                }
            }
        });

        // é¡µé¢éšè—æ—¶ä¹ŸåŒæ­¥(åˆ‡æ¢æ ‡ç­¾é¡µ)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && window.readTracker.latestItemId) {
                window.readTracker.syncNow();
            }
        });
    }

    // æ¸²æŸ“å›¾æ ‡
    (function () {
        const container = document.getElementById('rss-item-list');
        if (container && window.renderLucideIconsIn) {
            renderLucideIconsIn(container);
        }
    })();
</script>