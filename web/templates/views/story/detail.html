{{ template "base.html" . }}

{{ define "scripts" }}
<!-- Marked.js -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/js/editor.js"></script>
{{ end }}

{{ define "content" }}

<!-- Prose æ ·å¼ç»„ä»¶ -->
{{ template "prose_styles" . }}

<!-- åŒæ å¸ƒå±€: 8:4 é»„é‡‘æ¯”ä¾‹ -->
<div class="grid grid-cols-12 gap-6 md:gap-12">

    <!-- ä¸»å†…å®¹åŒº: col-span-8 -->
    <main class="col-span-12 lg:col-span-8">

        <!-- Article Section -->
        <article class="mb-8 md:mb-12">
            <!-- Header -->
            <header class="mb-8">
                <!-- Title -->
                <h1 class="font-sans font-bold text-2xl md:text-2.5xl text-ink leading-tight mb-3 break-words">
                    {{ if .Post.URL }}
                    <a href="{{ .Post.URL }}" target="_blank" rel="noopener noreferrer"
                        class="hover:text-moss transition-colors inline-flex items-center gap-2">
                        {{ .Post.Title }}
                        <i data-lucide="external-link" class="w-5 h-5 text-stone-400"></i>
                    </a>
                    <div class="text-sm font-normal text-stone-400 mt-1 truncate">
                        {{ .Post.URL }}
                    </div>
                    {{ else }}
                    {{ .Post.Title }}
                    {{ end }}
                </h1>

                <!-- Meta -->
                <div class="flex flex-wrap items-center text-sm text-stone-500 gap-y-2">
                    <span class="inline-flex items-center">
                        <i data-lucide="user" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        <a href="/u/{{ .Post.User.ID }}" class="font-medium hover:text-moss transition-colors">
                            {{ if eq .Post.SourceType "rss" }}ç”± {{ .Post.User.Username }} æ¨è{{ else }}{{
                            .Post.User.Username }}{{ end }}
                        </a>
                    </span>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <span title="{{ .Post.CreatedAt }}">
                        {{ timeAgo .Post.CreatedAt }}
                    </span>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <a href="/t/{{ .Post.Node.Name }}"
                        class="inline-flex items-center hover:text-moss transition-colors">
                        <i data-lucide="folder" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        {{ .Post.Node.Name }}
                    </a>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <span class="inline-flex items-center">
                        <i data-lucide="eye" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        {{ .Post.Views }}
                    </span>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <a href="#comments" class="inline-flex items-center hover:text-moss transition-colors">
                        <i data-lucide="message-square" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        {{ len .Comments }}
                    </a>

                    {{ if and .CurrentUser (eq .CurrentUser.ID .Post.UserID) }}
                    <span class="text-stone-300 mx-2">Â·</span>
                    <a href="/p/{{ .Post.Pid }}/edit" class="text-stone-400 hover:text-moss transition-colors text-xs">
                        ç¼–è¾‘
                    </a>
                    <span class="text-stone-300 mx-2">Â·</span>
                    <button hx-delete="/p/{{ .Post.Pid }}" hx-confirm="ç¡®å®šè¦ç§»é™¤è¿™æ£µç«¹å­å—ï¼Ÿ"
                        class="text-stone-400 hover:text-red-600 transition-colors cursor-pointer text-xs">
                        åˆ é™¤
                    </button>
                    {{ end }}
                </div>
            </header>

            <!-- Content Body -->
            {{ if .PostContent }}
            <div class="article-content overflow-hidden">
                <div class="prose prose-stone max-w-none prose-lg
                    prose-a:text-moss prose-a:no-underline hover:prose-a:underline
                    prose-headings:font-bold prose-headings:text-ink
                    prose-p:text-stone-700 prose-p:leading-relaxed
                    prose-code:text-moss-dark prose-code:bg-stone-100 prose-code:px-1 prose-code:rounded
                    prose-pre:bg-stone-900 prose-pre:text-stone-50
                    min-w-0 overflow-x-auto">
                    {{ .PostContent }}
                </div>
            </div>
            {{ end }}

            {{ if .User }}
            <!-- Article Action Bar (Unified for Mobile & Desktop) -->
            <div class="flex items-center justify-center gap-4">
                <!-- æ”¶è— -->
                <button hx-post="/bookmark/{{.Post.ID}}" hx-swap="innerHTML" hx-target="#bookmark-content-{{.Post.ID}}"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="æ”¶è—">
                    <div id="bookmark-content-{{.Post.ID}}" class="flex flex-col items-center gap-1">
                        <div
                            class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                            {{ if .IsBookmarked }}
                            <i data-lucide="bookmark" class="w-5 h-5 text-amber-500 fill-amber-500"></i>
                            {{ else }}
                            <i data-lucide="bookmark"
                                class="w-5 h-5 text-stone-400 group-hover:text-amber-500 transition-colors"></i>
                            {{ end }}
                        </div>
                        <span
                            class="text-xs font-semibold {{ if .IsBookmarked }}text-amber-600{{ else }}text-stone-500 group-hover:text-amber-600{{ end }}">æ”¶è—({{
                            .BookmarkCount }})</span>
                    </div>
                </button>

                <!-- ç‚¹èµ -->
                <button hx-post="/vote/post/{{.Post.ID}}" hx-swap="innerHTML" hx-target="#score-post-{{.Post.ID}}"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="ç‚¹èµ">
                    <div
                        class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                        <i data-lucide="triangle"
                            class="w-5 h-5 text-stone-400 group-hover:text-bamboo-500 transition-colors"></i>
                    </div>
                    <span id="score-post-{{.Post.ID}}"
                        class="text-xs font-semibold text-stone-500 group-hover:text-bamboo-600">èµ({{ .UpvoteCount
                        }})</span>
                </button>

                <!-- ç‚¹è¸© -->
                <button hx-post="/vote/post/{{.Post.ID}}/down" hx-swap="innerHTML" hx-target="#downvote-{{.Post.ID}}"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="ç‚¹è¸©">
                    <div
                        class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                        <i data-lucide="triangle"
                            class="w-5 h-5 rotate-180 text-stone-400 group-hover:text-stone-600 transition-colors"></i>
                    </div>
                    <span id="downvote-{{.Post.ID}}"
                        class="text-xs font-semibold text-stone-500 group-hover:text-stone-600">è¸©({{ .DownvoteCount
                        }})</span>
                </button>
            </div>
            {{ end }}
        </article>

        <!-- Divider -->
        <hr class="border-stone-200/60 mb-10">

        <!-- Comment Section -->
        <section id="comments">
            <!-- Comment List Header -->
            <div class="mb-6">
                <h3 class="font-bold text-ink text-lg flex items-center gap-2">
                    è¯„è®º
                    <span class="text-sm font-normal text-stone-400 ml-1">{{ len .Comments }} æ¡</span>
                </h3>
            </div>

            <!-- Comment List -->
            {{ if .Comments }}
            <div class="divide-y divide-stone-100">
                {{ range .Comments }}
                {{ template "comment_item" dict "ID" .ID "Cid" .Cid "Floor" .Floor "Score" .Score "User" .User "UserID"
                .UserID "CreatedAt" .CreatedAt "ContentHTML" .ContentHTML "CurrentUser" $.CurrentUser }}
                {{ end }}
            </div>
            {{ else }}
            <div class="py-12 text-center bg-stone-50/50 rounded-lg border border-dashed border-stone-200 mb-8">
                <p class="text-stone-400">æš‚æ— è¯„è®ºï¼Œæ¥ç§ä¸‹ç¬¬ä¸€é¢—ç§å­ã€‚</p>
            </div>
            {{ end }}

            <!-- Comment Form (ç§»åˆ°åº•éƒ¨) -->
            <div id="comment-form" class="mt-8 pt-8 border-t border-stone-200 scroll-mt-24">
                <!-- å›å¤æç¤ºæ¡ -->
                <div id="reply-hint"
                    class="hidden mb-4 p-3 bg-moss/5 border border-moss/20 rounded-lg flex justify-between items-center">
                    <span class="text-sm text-moss">
                        ğŸ“ æ­£åœ¨å›å¤ <span id="reply-hint-floor" class="font-bold"></span> æ¥¼ï¼ˆ<span
                            id="reply-hint-user"></span>ï¼‰
                    </span>
                    <button type="button" onclick="cancelReply()"
                        class="text-xs text-stone-500 hover:text-red-500 transition-colors">
                        å–æ¶ˆå›å¤
                    </button>
                </div>

                <form action="/p/{{ .Post.Pid }}/comment" method="POST" class="relative group">
                    <!-- éšè—å­—æ®µ -->
                    <input type="hidden" name="parent_id" id="reply-parent-id" value="">
                    <input type="hidden" name="reply_floor" id="reply-floor" value="">

                    {{ template "markdown_editor" dict "Name" "content" "Placeholder" "å‘è¡¨ä½ çš„è§è§£... (æ”¯æŒ Markdown)" }}

                    <div class="flex justify-end mt-3">
                        <button type="submit" class="bg-moss text-white px-6 py-2 rounded-md font-medium text-sm
                                   hover:bg-moss-dark transition-colors shadow-sm
                                   disabled:opacity-50 disabled:cursor-not-allowed">
                            å‘è¡¨è¯„è®º
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- å›å¤äº¤äº’è„šæœ¬ -->
        <script>
            // è®¾ç½®å›å¤çŠ¶æ€
            function setReply(commentId, floor, username) {
                document.getElementById('reply-parent-id').value = commentId;
                document.getElementById('reply-floor').value = floor;
                document.getElementById('reply-hint-floor').textContent = '#' + floor;
                document.getElementById('reply-hint-user').textContent = '@' + username;
                document.getElementById('reply-hint').classList.remove('hidden');

                // æ»šåŠ¨åˆ°è¯„è®ºæ¡†
                document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth', block: 'start' });

                // èšç„¦ç¼–è¾‘å™¨
                setTimeout(() => {
                    const editor = document.querySelector('#comment-form textarea');
                    if (editor) editor.focus();
                }, 300);
            }

            // å–æ¶ˆå›å¤
            function cancelReply() {
                document.getElementById('reply-parent-id').value = '';
                document.getElementById('reply-floor').value = '';
                document.getElementById('reply-hint').classList.add('hidden');
            }
        </script>

    </main>

    <!-- ä¾§è¾¹æ : col-span-4, sticky -->
    <aside class="hidden lg:block lg:col-span-4">
        <div class="sticky top-24 space-y-6">

            <!-- Submit Button -->
            <a href="/submit"
                class="block bg-moss text-white w-full text-center py-2.5 rounded-md font-medium hover:opacity-90 transition shadow-sm hover:shadow">
                å‘å¸ƒæ–°å†…å®¹
            </a>

            <!-- Site Description -->
            <div class="bg-stone-50 rounded-lg p-5 border border-stone-100">
                <h3 class="font-bold text-ink mb-2 text-sm">å…³äº ZhuLink</h3>
                <p class="text-xs text-stone-600 leading-relaxed text-justify">
                    ä¸€ä¸ªç”±ç”¨æˆ·åˆ†äº«ã€æ¨èä¼˜è´¨èµ„è®¯çš„ç¤¾åŒºï¼Œä¾é ç”¨æˆ·å…±è¯†æŒ‘å‡ºå€¼å¾—ä¸€è¯»çš„å†…å®¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ¨å´‡"ç™½çº¸å¢¨å­—"çš„é˜…è¯»ä½“éªŒã€‚
                </p>
            </div>

        </div>
    </aside>

</div>


<style>
    /* CSS æ¸²æŸ“ä¼˜åŒ–ï¼šå±å¹•å¤–çš„è¯„è®ºé¡¹ä¸æ¸²æŸ“ */
    .divide-y>article,
    .divide-y>div[id^="comment-"] {
        content-visibility: auto;
        contain-intrinsic-size: 0 120px;
        /* é¢„ä¼°è¯„è®ºé«˜åº¦ */
    }
</style>

{{ end }}