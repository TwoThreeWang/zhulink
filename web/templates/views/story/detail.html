{{ template "base.html" . }}

{{ define "scripts" }}
<!-- Marked.js -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/js/editor.js"></script>

<!-- SEO Metaæ ‡ç­¾ -->
<meta name="description" content="{{ .Description }}">
<meta name="keywords" content="{{ .Keywords }}">
<meta name="author" content="{{ .Author }}">

<!-- Open Graphæ ‡ç­¾ (ç”¨äºç¤¾äº¤åª’ä½“åˆ†äº«) -->
<meta property="og:type" content="article">
<meta property="og:title" content="{{ .Post.Title }}">
<meta property="og:description" content="{{ .Description }}">
<meta property="og:url" content="{{ .FullURL }}">
<meta property="og:site_name" content="ZhuLink ç«¹æ—">
<meta property="article:author" content="{{ .Author }}">
<meta property="article:published_time" content="{{ .PublishedTime }}">
<meta property="article:modified_time" content="{{ .ModifiedTime }}">
<meta property="article:section" content="{{ .Post.Node.Name }}">

<!-- Twitter Cardæ ‡ç­¾ -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="{{ .Post.Title }}">
<meta name="twitter:description" content="{{ .Description }}">

<!-- Canonicalé“¾æ¥ -->
<link rel="canonical" href="{{ .FullURL }}">

<!-- JSON-LDç»“æ„åŒ–æ•°æ® -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "{{ .Post.Title }}",
  "description": "{{ .Description }}",
  "author": {
    "@type": "Person",
    "name": "{{ .Author }}"
  },
  "datePublished": "{{ .PublishedTime }}",
  "dateModified": "{{ .ModifiedTime }}",
  "publisher": {
    "@type": "Organization",
    "name": "ZhuLink ç«¹æ—",
    "logo": {
      "@type": "ImageObject",
      "url": "https://zhulink.com/static/img/logo.svg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ .FullURL }}"
  },
  "articleSection": "{{ .Post.Node.Name }}",
  "interactionStatistic": [
    {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/ViewAction",
      "userInteractionCount": {{ .Post.Views }}
    },
    {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/CommentAction",
      "userInteractionCount": {{ len .Comments }}
    },
    {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/LikeAction",
      "userInteractionCount": {{ .UpvoteCount }}
    }
  ]{{ if .Post.URL }},
  "url": "{{ .Post.URL }}"{{ end }}
}
</script>
{{ end }}

{{ define "content" }}

<!-- Prose æ ·å¼ç»„ä»¶ -->
{{ template "prose_styles" . }}

<!-- åŒæ å¸ƒå±€: 8:4 é»„é‡‘æ¯”ä¾‹ -->
<div class="grid grid-cols-12 gap-6 md:gap-12">

    <!-- ä¸»å†…å®¹åŒº: col-span-8 -->
    <main class="col-span-12 lg:col-span-8">

        <!-- Article Section -->
        <article class="mb-8 md:mb-12">
            <!-- Header -->
            <header class="mb-8">
                <!-- Title -->
                <h1 class="font-sans font-bold text-2xl md:text-2.5xl text-ink leading-tight mb-3 break-words">
                    {{ if .Post.URL }}
                    <a href="{{ .Post.URL }}" target="_blank" rel="noopener noreferrer"
                        class="hover:text-moss transition-colors inline-flex items-center gap-2">
                        {{ .Post.Title }}
                        <i data-lucide="external-link" class="w-5 h-5 text-stone-400"></i>
                    </a>
                    <div class="text-sm font-normal text-stone-400 mt-1 truncate">
                        {{ .Post.URL }}
                    </div>
                    {{ else }}
                    {{ .Post.Title }}
                    {{ end }}
                </h1>

                <!-- Meta -->
                <div class="flex flex-wrap items-center text-sm text-stone-500 gap-y-2">
                    <span class="inline-flex items-center">
                        <i data-lucide="user" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        <a href="/u/{{ .Post.User.ID }}" class="font-medium hover:text-moss transition-colors">
                            {{ if eq .Post.SourceType "rss" }}ç”± {{ .Post.User.Username }} æ¨è{{ else }}{{
                            .Post.User.Username }}{{ end }}
                        </a>
                    </span>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <span title="{{ .Post.CreatedAt }}">
                        {{ timeAgo .Post.CreatedAt }}
                    </span>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <a href="/t/{{ .Post.Node.Name }}"
                        class="inline-flex items-center hover:text-moss transition-colors">
                        <i data-lucide="folder" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        {{ .Post.Node.Name }}
                    </a>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <span class="inline-flex items-center">
                        <i data-lucide="eye" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        {{ .Post.Views }}
                    </span>

                    <span class="text-stone-300 mx-2">Â·</span>

                    <a href="#comments" class="inline-flex items-center hover:text-moss transition-colors">
                        <i data-lucide="message-square" class="w-3.5 h-3.5 mr-1.5 opacity-70"></i>
                        {{ len .Comments }}
                    </a>

                    {{ if and .CurrentUser (eq .CurrentUser.ID .Post.UserID) }}
                    <span class="text-stone-300 mx-2">Â·</span>
                    <a href="/p/{{ .Post.Pid }}/edit" class="text-stone-400 hover:text-moss transition-colors text-xs">
                        ç¼–è¾‘
                    </a>
                    <span class="text-stone-300 mx-2">Â·</span>
                    <button hx-delete="/p/{{ .Post.Pid }}" hx-confirm="ç¡®å®šè¦ç§»é™¤è¿™æ£µç«¹å­å—ï¼Ÿ"
                        class="text-stone-400 hover:text-red-600 transition-colors cursor-pointer text-xs">
                        åˆ é™¤
                    </button>
                    {{ end }}
                </div>
            </header>

            <!-- Content Body -->
            {{ if .PostContent }}
            <div class="article-content overflow-hidden">
                <div class="prose prose-stone max-w-none prose-lg
                    prose-a:text-moss prose-a:no-underline hover:prose-a:underline
                    prose-headings:font-bold prose-headings:text-ink
                    prose-p:text-stone-700 prose-p:leading-loose
                    prose-code:text-moss-dark prose-code:bg-stone-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded
                    prose-pre:bg-neutral-800 prose-pre:text-neutral-200 prose-pre:shadow-lg prose-pre:border prose-pre:border-neutral-700
                    min-w-0 overflow-x-auto">
                    {{ .PostContent }}
                </div>
            </div>
            {{ end }}

            {{ if .CurrentUser }}
            <!-- Article Action Bar (Unified for Mobile & Desktop) -->
            <div class="flex items-center justify-center gap-4">
                <!-- æ”¶è— -->
                <button hx-post="/bookmark/{{.Post.ID}}" hx-swap="innerHTML" hx-target="#bookmark-content-{{.Post.ID}}"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="æ”¶è—">
                    <div id="bookmark-content-{{.Post.ID}}" class="flex flex-col items-center gap-1">
                        <div
                            class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                            {{ if .IsBookmarked }}
                            <i data-lucide="bookmark" class="w-5 h-5 text-amber-500 fill-amber-500"></i>
                            {{ else }}
                            <i data-lucide="bookmark"
                                class="w-5 h-5 text-stone-400 group-hover:text-amber-500 transition-colors"></i>
                            {{ end }}
                        </div>
                        <span
                            class="text-xs font-semibold {{ if .IsBookmarked }}text-amber-600{{ else }}text-stone-500 group-hover:text-amber-600{{ end }}">æ”¶è—({{
                            .BookmarkCount }})</span>
                    </div>
                </button>

                <!-- ç‚¹èµ -->
                <button hx-post="/vote/post/{{.Post.ID}}" hx-swap="innerHTML" hx-target="#score-post-{{.Post.ID}}"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="ç‚¹èµ">
                    <div
                        class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                        <i data-lucide="triangle"
                            class="w-5 h-5 text-stone-400 group-hover:text-bamboo-500 transition-colors"></i>
                    </div>
                    <span id="score-post-{{.Post.ID}}"
                        class="text-xs font-semibold text-stone-500 group-hover:text-bamboo-600">èµ({{ .UpvoteCount
                        }})</span>
                </button>

                <!-- ç‚¹è¸© -->
                <button hx-post="/vote/post/{{.Post.ID}}/down" hx-swap="innerHTML" hx-target="#downvote-{{.Post.ID}}"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="ç‚¹è¸©">
                    <div
                        class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                        <i data-lucide="triangle"
                            class="w-5 h-5 rotate-180 text-stone-400 group-hover:text-stone-600 transition-colors"></i>
                    </div>
                    <span id="downvote-{{.Post.ID}}"
                        class="text-xs font-semibold text-stone-500 group-hover:text-stone-600">è¸©({{ .DownvoteCount
                        }})</span>
                </button>

                <!-- ä¸¾æŠ¥ -->
                <button onclick="reportItem('post', {{.Post.ID}})"
                    class="flex flex-col items-center gap-1 p-2.5 rounded-xl hover:bg-stone-50 transition-colors group min-w-[3.5rem]"
                    title="ä¸¾æŠ¥">
                    <div
                        class="p-1.5 rounded-full bg-stone-50 group-hover:bg-white group-hover:shadow-sm transition-all border border-transparent group-hover:border-stone-100">
                        <i data-lucide="flag"
                            class="w-5 h-5 text-stone-400 group-hover:text-red-500 transition-colors"></i>
                    </div>
                    <span class="text-xs font-semibold text-stone-500 group-hover:text-red-600">ä¸¾æŠ¥</span>
                </button>
            </div>

            <!-- Admin Actions -->
            {{ if and .CurrentUser (eq .CurrentUser.Role "admin") }}
            <div
                class="mt-8 p-4 bg-stone-50/50 rounded-xl border border-dashed border-stone-200 flex flex-wrap items-center justify-center gap-4">
                <span class="text-xs font-bold text-stone-400 uppercase tracking-widest mr-2">ç®¡ç†æ“ä½œ</span>

                <button hx-post="/admin/post/{{.Post.Pid}}/top" hx-swap="innerHTML"
                    class="px-4 py-1.5 bg-white border border-stone-200 rounded-lg text-sm font-medium text-stone-600 hover:border-moss hover:text-moss transition-all shadow-sm">
                    {{ if .Post.IsTop }}å–æ¶ˆç½®é¡¶{{ else }}ç½®é¡¶{{ end }}
                </button>

                <div class="flex items-center">
                    <select onchange="moveNode('{{.Post.Pid}}', this.value)"
                        class="px-3 py-1.5 bg-white border border-stone-200 rounded-lg text-sm text-stone-600 focus:ring-1 focus:ring-moss focus:border-moss outline-none shadow-sm transition-all cursor-pointer">
                        <option value="">ç§»åŠ¨è‡³æ–°èŠ‚ç‚¹</option>
                        {{ range .Nodes }}
                        <option value="{{.ID}}" {{ if eq .ID $.Post.NodeID }}disabled{{ end }}>{{.Name}}</option>
                        {{ end }}
                    </select>
                </div>

                <button hx-delete="/admin/post/{{.Post.Pid}}" hx-confirm="ç®¡ç†å‘˜ç¡®å®šè¦åˆ é™¤è¿™æ£µç«¹å­å—ï¼Ÿ"
                    class="px-4 py-1.5 bg-white border border-red-100 rounded-lg text-sm font-medium text-red-400 hover:bg-red-500 hover:text-white transition-all shadow-sm">
                    å½»åº•åˆ é™¤
                </button>
            </div>

            <script>
                function moveNode(pid, nodeID) {
                    if (!nodeID) return;
                    if (confirm('ç¡®å®šè¦ç§»åŠ¨èŠ‚ç‚¹å—ï¼Ÿ')) {
                        const formData = new FormData();
                        formData.append('node_id', nodeID);
                        fetch('/admin/post/' + pid + '/move', {
                            method: 'POST',
                            body: formData,
                            headers: { 'HX-Request': 'true' }
                        }).then(r => { if (r.ok) location.reload(); });
                    }
                }
            </script>
            {{ end }}

            <script>
                function reportItem(type, id) {
                    const reason = prompt('è¯·è¾“å…¥ä¸¾æŠ¥åŸå› ï¼š');
                    if (reason) {
                        const formData = new FormData();
                        formData.append('reason', reason);
                        fetch('/report/' + type + '/' + id, {
                            method: 'POST',
                            body: formData,
                            headers: { 'HX-Request': 'true' }
                        }).then(r => {
                            if (r.ok) alert('ä¸¾æŠ¥å·²æäº¤ï¼Œæ„Ÿè°¢æ‚¨çš„ç»´æŠ¤ï¼');
                        });
                    }
                }
            </script>
            {{ end }}
        </article>

        <!-- Divider -->
        <hr class="border-stone-200/60 mb-10">

        <!-- Comment Section -->
        <section id="comments">
            <!-- Comment List Header -->
            <div class="mb-6">
                <h3 class="font-bold text-ink text-lg flex items-center gap-2">
                    è¯„è®º
                    <span class="text-sm font-normal text-stone-400 ml-1">{{ len .Comments }} æ¡</span>
                </h3>
            </div>

            <!-- Comment List -->
            {{ if .Comments }}
            <div class="divide-y divide-stone-100">
                {{ range .Comments }}
                {{ template "comment_item" dict "ID" .ID "Cid" .Cid "Floor" .Floor "Score" .Score "User" .User "UserID"
                .UserID "CreatedAt" .CreatedAt "ContentHTML" .ContentHTML "CurrentUser" $.CurrentUser }}
                {{ end }}
            </div>
            {{ else }}
            <div class="py-12 text-center bg-stone-50/50 rounded-lg border border-dashed border-stone-200 mb-8">
                <p class="text-stone-400">æš‚æ— è¯„è®ºï¼Œæ¥ç§ä¸‹ç¬¬ä¸€é¢—ç§å­ã€‚</p>
            </div>
            {{ end }}

            <!-- Comment Form (ç§»åˆ°åº•éƒ¨) -->
            <div id="comment-form" class="mt-8 pt-8 border-t border-stone-200 scroll-mt-24">
                <!-- å›å¤æç¤ºæ¡ -->
                <div id="reply-hint"
                    class="hidden mb-4 p-3 bg-moss/5 border border-moss/20 rounded-lg flex justify-between items-center">
                    <span class="text-sm text-moss">
                        ğŸ“ æ­£åœ¨å›å¤ <span id="reply-hint-floor" class="font-bold"></span> æ¥¼ï¼ˆ<span
                            id="reply-hint-user"></span>ï¼‰
                    </span>
                    <button type="button" onclick="cancelReply()"
                        class="text-xs text-stone-500 hover:text-red-500 transition-colors">
                        å–æ¶ˆå›å¤
                    </button>
                </div>

                <form action="/p/{{ .Post.Pid }}/comment" method="POST" class="relative group">
                    <!-- éšè—å­—æ®µ -->
                    <input type="hidden" name="parent_id" id="reply-parent-id" value="">
                    <input type="hidden" name="reply_floor" id="reply-floor" value="">

                    {{ template "markdown_editor" dict "Name" "content" "Placeholder" "å‘è¡¨ä½ çš„è§è§£... (æ”¯æŒ Markdown)" }}

                    <div class="flex justify-end mt-3">
                        <button type="submit" class="bg-moss text-white px-6 py-2 rounded-md font-medium text-sm
                                   hover:bg-moss-dark transition-colors shadow-sm
                                   disabled:opacity-50 disabled:cursor-not-allowed">
                            å‘è¡¨è¯„è®º
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- å›å¤äº¤äº’è„šæœ¬ -->
        <script>
            // è®¾ç½®å›å¤çŠ¶æ€
            function setReply(commentId, floor, username) {
                document.getElementById('reply-parent-id').value = commentId;
                document.getElementById('reply-floor').value = floor;
                document.getElementById('reply-hint-floor').textContent = '#' + floor;
                document.getElementById('reply-hint-user').textContent = '@' + username;
                document.getElementById('reply-hint').classList.remove('hidden');

                // æ»šåŠ¨åˆ°è¯„è®ºæ¡†
                document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth', block: 'start' });

                // èšç„¦ç¼–è¾‘å™¨
                setTimeout(() => {
                    const editor = document.querySelector('#comment-form textarea');
                    if (editor) editor.focus();
                }, 300);
            }

            // å–æ¶ˆå›å¤
            function cancelReply() {
                document.getElementById('reply-parent-id').value = '';
                document.getElementById('reply-floor').value = '';
                document.getElementById('reply-hint').classList.add('hidden');
            }
        </script>

    </main>

    <!-- ä¾§è¾¹æ : col-span-4, sticky -->
    <aside class="hidden lg:block lg:col-span-4">
        <div class="sticky top-24 space-y-6">

            <!-- Submit Button -->
            <a href="/submit"
                class="block bg-moss text-white w-full text-center py-2.5 rounded-md font-medium hover:opacity-90 transition shadow-sm hover:shadow">
                å‘å¸ƒæ–°å†…å®¹
            </a>

            <!-- Site Description -->
            <div class="bg-stone-50 rounded-lg p-5 border border-stone-100">
                <h3 class="font-bold text-ink mb-2 text-sm">å…³äº ZhuLink</h3>
                <p class="text-xs text-stone-600 leading-relaxed text-justify">
                    ä¸€ä¸ªç”±ç”¨æˆ·åˆ†äº«ã€æ¨èä¼˜è´¨èµ„è®¯çš„ç¤¾åŒºï¼Œä¾é ç”¨æˆ·å…±è¯†æŒ‘å‡ºå€¼å¾—ä¸€è¯»çš„å†…å®¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ¨å´‡"ç™½çº¸å¢¨å­—"çš„é˜…è¯»ä½“éªŒã€‚
                </p>
            </div>

            <!-- google -->
            <div class="hidden lg:block">
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4678475430515042"
                    crossorigin="anonymous"></script>
                <!-- è‡ªé€‚åº” -->
                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4678475430515042"
                    data-ad-slot="5275519214" data-ad-format="auto" data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>

        </div>
    </aside>

</div>




<style>
    /* CSS æ¸²æŸ“ä¼˜åŒ–ï¼šå±å¹•å¤–çš„è¯„è®ºé¡¹ä¸æ¸²æŸ“ */
    .divide-y>article,
    .divide-y>div[id^="comment-"] {
        content-visibility: auto;
        contain-intrinsic-size: 0 120px;
        /* é¢„ä¼°è¯„è®ºé«˜åº¦ */
    }

    /* å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹å™¨æ ·å¼ */
    #image-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        cursor: pointer;
        animation: fadeIn 0.2s ease;
    }

    #image-viewer.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #image-viewer img {
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
        animation: zoomIn 0.2s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes zoomIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* æ–‡ç« å†…å›¾ç‰‡æ·»åŠ ç‚¹å‡»æç¤º */
    .article-content img {
        cursor: zoom-in;
        transition: opacity 0.2s;
    }

    .article-content img:hover {
        opacity: 0.9;
    }

    /* å“åº”å¼è§†é¢‘å®¹å™¨ */
    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        /* 16:9 æ¯”ä¾‹ */
        height: 0;
        overflow: hidden;
        margin: 1.5rem 0;
        border-radius: 0.5rem;
        background: #f5f5f5;
    }

    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
    }
</style>

<!-- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹å™¨ -->
<div id="image-viewer">
    <img src="" alt="">
</div>

<script>
    // å›¾ç‰‡æ”¾å¤§åŠŸèƒ½
    (function () {
        const viewer = document.getElementById('image-viewer');
        const viewerImg = viewer.querySelector('img');
        const articleContent = document.querySelector('.article-content');

        if (!articleContent) return;

        // ä¸ºæ‰€æœ‰æ–‡ç« å›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
        articleContent.querySelectorAll('img').forEach(img => {
            img.addEventListener('click', function (e) {
                e.stopPropagation();
                viewerImg.src = this.src;
                viewerImg.alt = this.alt;
                viewer.classList.add('show');
                document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            });
        });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        viewer.addEventListener('click', function () {
            viewer.classList.remove('show');
            document.body.style.overflow = '';
        });

        // ESCé”®å…³é—­
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && viewer.classList.contains('show')) {
                viewer.classList.remove('show');
                document.body.style.overflow = '';
            }
        });
    })();
</script>

{{ end }}