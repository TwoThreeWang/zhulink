{{ template "base.html" . }}

{{ define "content" }}
<!-- Dashboard 消息中心 - 紧凑、去框化设计 -->

<div class="max-w-5xl mx-auto py-8">
    <div class="flex flex-col md:flex-row gap-8 md:gap-12">
        <!-- 侧边栏 -->
        <aside class="md:w-48 flex-shrink-0">
            {{ template "dashboard_sidebar.html" dict "Active" "notifications" "UnreadCount" 0 }}
        </aside>

        <!-- 主内容区 -->
        <main class="flex-grow min-w-0">
            <div class="flex items-center justify-between mb-6 pl-1">
                <h1 class="text-xl font-bold text-ink">消息中心</h1>
                {{ if .Notifications }}
                <form action="/notifications/read-all" method="post">
                    <button type="submit"
                        class="text-xs text-stone-400 hover:text-moss transition-colors flex items-center gap-1.5">
                        <i data-lucide="check-check" class="w-3.5 h-3.5"></i>
                        全部已读
                    </button>
                </form>
                {{ end }}
            </div>

            {{ if .Notifications }}
            <div class="space-y-4">
                {{ range .Notifications }}
                <div id="notification-{{ .ID }}"
                    class="relative pl-4 border-l-2 {{ if .IsRead }}border-stone-100 opacity-60{{ else }}border-moss bg-moss/5{{ end }} rounded-r py-3 px-3 transition-all hover:bg-stone-50 group">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-grow min-w-0">
                            <div class="text-sm text-stone-600 mb-1.5 leading-relaxed">
                                <a href="/u/{{ .Actor.ID }}"
                                    class="font-medium text-ink hover:text-moss transition-colors">{{ .Actor.Username
                                    }}</a>
                                {{ if eq .Type "comment_post" }}
                                <span class="text-stone-400 mx-1">评论了文章</span>
                                <a href="/p/{{ .Post.Pid }}#comment-{{ .CommentID }}"
                                    class="text-ink hover:text-moss hover:underline decoration-moss/30 underline-offset-2 transition-colors">
                                    {{ .Post.Title }}
                                </a>
                                {{ else if eq .Type "reply_comment" }}
                                <span class="text-stone-400 mx-1">在文章</span>
                                <a href="/p/{{ .Post.Pid }}"
                                    class="text-ink hover:text-moss hover:underline decoration-moss/30 underline-offset-2 transition-colors">{{
                                    .Post.Title }}</a>
                                <span class="text-stone-400 mx-1">中回复了你</span>
                                {{ end }}
                            </div>

                            {{ if .Comment.Content }}
                            <div
                                class="text-sm text-stone-500 bg-stone-50/50 p-2.5 rounded border border-stone-100/50 line-clamp-2 prose prose-sm max-w-none prose-p:my-0">
                                {{ .Comment.Content }}
                            </div>
                            {{ end }}

                            <div class="mt-2 text-xs text-stone-300 flex items-center gap-2">
                                {{ timeAgo .CreatedAt }}
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div
                            class="flex-shrink-0 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            {{ if not .IsRead }}
                            <button hx-post="/notifications/{{ .ID }}/read" hx-swap="none"
                                onclick="const item = this.closest('[id^=notification-]'); item.classList.remove('border-moss', 'bg-moss/5'); item.classList.add('border-stone-100', 'opacity-60'); this.remove()"
                                class="p-1.5 text-moss hover:bg-moss/10 rounded transition-colors" title="标记为已读">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            {{ end }}
                            <button hx-delete="/notifications/{{ .ID }}" hx-target="#notification-{{ .ID }}"
                                hx-swap="outerHTML"
                                class="p-1.5 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"
                                title="删除">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {{ end }}
            </div>

            {{ else }}
            <!-- 禅意空状态 -->
            <div class="py-12 text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-stone-50 mb-3">
                    <i data-lucide="bell-off" class="w-6 h-6 text-stone-300"></i>
                </div>
                <p class="text-stone-400 text-sm font-medium">空山不见人，但闻人语响</p>
                <p class="text-xs text-stone-300 mt-1">暂无未读消息</p>
            </div>
            {{ end }}
        </main>
    </div>
</div>

<style>
    /* CSS 渲染优化：屏幕外的通知项不渲染 */
    .space-y-4>div[id^="notification-"] {
        content-visibility: auto;
        contain-intrinsic-size: 0 100px;
        /* 预估通知高度 */
    }
</style>

{{ end }}